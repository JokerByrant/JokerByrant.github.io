<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="tc_Da-z9B63hr5UDxcMmjC72dU1h43Kw82L65l5U7ps">
  <meta name="baidu-site-verification" content="code-yltW3it9oB">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jokerbyrant.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="SpringBoot 中内置了 Servlet 容器，支持 Tomcat ， Jetty 和 Undertow 服务器，所以可以直接运行。相比之下，传统的JavaWeb程序则需要嵌入到Tomcat之类的 Servlet 容器中才能运行。接下来就来学习一下， SpringBoot 加载内置的 Servlet 容器的流程。">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringBoot源码学习(三)---内置Servlet容器加载流程">
<meta property="og:url" content="https://jokerbyrant.github.io/2020-08-24/30562/index.html">
<meta property="og:site_name" content="Sssxh BLOG">
<meta property="og:description" content="SpringBoot 中内置了 Servlet 容器，支持 Tomcat ， Jetty 和 Undertow 服务器，所以可以直接运行。相比之下，传统的JavaWeb程序则需要嵌入到Tomcat之类的 Servlet 容器中才能运行。接下来就来学习一下， SpringBoot 加载内置的 Servlet 容器的流程。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ae01.alicdn.com/kf/U6bea8f9a32c54e1ba5f5f607cbf5fe6d8.jpg">
<meta property="og:image" content="https://ae01.alicdn.com/kf/U057c7dcbcaf84639b7485ed4edbc442cY.jpg">
<meta property="og:image" content="https://ae01.alicdn.com/kf/U0799dee9f7204848bf55cfa5309a45c5Q.jpg">
<meta property="og:image" content="https://ae01.alicdn.com/kf/U75e56c15f3124f32a624fd9928842817M.jpg">
<meta property="article:published_time" content="2020-08-24T08:28:26.000Z">
<meta property="article:modified_time" content="2021-11-12T06:40:30.594Z">
<meta property="article:author" content="sxh">
<meta property="article:tag" content="SpringBoot">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ae01.alicdn.com/kf/U6bea8f9a32c54e1ba5f5f607cbf5fe6d8.jpg">

<link rel="canonical" href="https://jokerbyrant.github.io/2020-08-24/30562/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>SpringBoot源码学习(三)---内置Servlet容器加载流程 | Sssxh BLOG</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sssxh BLOG</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jokerbyrant.github.io/2020-08-24/30562/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://fastly.jsdelivr.net/gh/JokerByrant/Images@main/blog/16996066179231699606617191.png">
      <meta itemprop="name" content="sxh">
      <meta itemprop="description" content="人类的悲欢并不相通">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sssxh BLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SpringBoot源码学习(三)---内置Servlet容器加载流程
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-24 16:28:26" itemprop="dateCreated datePublished" datetime="2020-08-24T16:28:26+08:00">2020-08-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">后端技术</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><code>SpringBoot</code> 中内置了 <code>Servlet</code> 容器，支持 <code>Tomcat</code> ， <code>Jetty</code> 和 <code>Undertow</code> 服务器，所以可以直接运行。相比之下，传统的<code>JavaWeb</code>程序则需要嵌入到<code>Tomcat</code>之类的 <code>Servlet</code> 容器中才能运行。接下来就来学习一下， <code>SpringBoot</code> 加载内置的 <code>Servlet</code> 容器的流程。</p>
<span id="more"></span>

<h2 id="一、相关类介绍"><a href="#一、相关类介绍" class="headerlink" title="一、相关类介绍"></a>一、相关类介绍</h2><h3 id="WebServer"><a href="#WebServer" class="headerlink" title="WebServer"></a><code>WebServer</code></h3><p><code>SpringBoot</code> 对内置的 <code>Servlet</code> 容器做了一层封装</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WebServer</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 启动内置的Servlet容器</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> WebServerException</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 关闭内置Servlet容器</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> <span class="keyword">throws</span> WebServerException</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 获取内置Servlet容器监听的端口</span></span><br><span class="line">   <span class="function"><span class="keyword">int</span> <span class="title">getPort</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它目前有下图中五个实现类，对应了四种容器 <code>Jetty</code> 、 <code>Tomcat</code> 、 <code>UnderTow</code> 、 <code>Netty</code> ，其中 <code>Netty</code> 不是 <code>Servlet</code> 容器。<br><img src="https://ae01.alicdn.com/kf/U6bea8f9a32c54e1ba5f5f607cbf5fe6d8.jpg" alt="Java中的五中Servlet实现类"></p>
<h3 id="ServletWebServerFactory"><a href="#ServletWebServerFactory" class="headerlink" title="ServletWebServerFactory"></a><code>ServletWebServerFactory</code></h3><p><code>ServletWebServerFactory</code> 是一个工厂接口，用来生产 <code>WebServer</code> 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServletWebServerFactory</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 获取已经配置好的内置Servlet容器，这个容器还没有监听端口，需要手动调用内置Servlet容器的start方法进行监听</span></span><br><span class="line">   <span class="function">WebServer <span class="title">getWebServer</span><span class="params">(ServletContextInitializer... initializers)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ServletContextInitializer"><a href="#ServletContextInitializer" class="headerlink" title="ServletContextInitializer"></a><code>ServletContextInitializer</code></h3><p><code>ServletContextInitializer</code> 是 <strong>Servlet初始化器</strong>，用于配置 <code>ServletContext</code> ，在调用 <code>getWebServer()</code> 方法创建 <strong>Servlet内置容器</strong> 的时候会调用它的 <code>onStartup()</code> 方法，<code>getWebServer()</code> 方法何时调用会在后续讲 Servlet 容器的创建和启动时讲到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServletContextInitializer</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 对ServletContext进行一些配置</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ServletWebServerFactoryAutoConfiguration"><a href="#ServletWebServerFactoryAutoConfiguration" class="headerlink" title="ServletWebServerFactoryAutoConfiguration"></a><code>ServletWebServerFactoryAutoConfiguration</code></h3><p>下面我们来看看 <code>ServletWebServerFactory</code> 是怎么被注册到Spring容器中的。找到 <code>ServletWebServerFactoryAutoConfiguration.class</code>，这个类是 Servlet 容器的自动配置类，可以在 <code>spring.factories</code> 中找到这个类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// 最高优先级</span></span><br><span class="line"><span class="meta">@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(ServletRequest.class)</span></span><br><span class="line"><span class="comment">// 只有在servlet型环境下才起作用</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(ServerProperties.class)</span></span><br><span class="line"><span class="comment">// 配置三种类型的容器工厂Bean</span></span><br><span class="line"><span class="comment">// 并Import一个内部类BeanPostProcessorsRegistrar，用来注册一个WebServerFactoryCustomizerBeanPostProcessor到Spring容器中，这个类主要用来调用WebServerFactoryCustomizer的实现类，来完成对WebServerFactory进行自定义</span></span><br><span class="line"><span class="meta">@Import(&#123; ServletWebServerFactoryAutoConfiguration.BeanPostProcessorsRegistrar.class,</span></span><br><span class="line"><span class="meta">      ServletWebServerFactoryConfiguration.EmbeddedTomcat.class,</span></span><br><span class="line"><span class="meta">      ServletWebServerFactoryConfiguration.EmbeddedJetty.class,</span></span><br><span class="line"><span class="meta">      ServletWebServerFactoryConfiguration.EmbeddedUndertow.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletWebServerFactoryAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> ServletWebServerFactoryCustomizer <span class="title">servletWebServerFactoryCustomizer</span><span class="params">(ServerProperties serverProperties)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ServletWebServerFactoryCustomizer(serverProperties);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="meta">@ConditionalOnClass(name = &quot;org.apache.catalina.startup.Tomcat&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> TomcatServletWebServerFactoryCustomizer <span class="title">tomcatServletWebServerFactoryCustomizer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">         ServerProperties serverProperties)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> TomcatServletWebServerFactoryCustomizer(serverProperties);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 在ServletWebServerFactoryAutoConfiguration自动配置类中被导入，实现了BeanFactoryAware接口(BeanFactory会被自动注入进来)和ImportBeanDefinitionRegistrar接口(会被ConfigurationClassBeanDefinitionReader解析并注册到Spring容器中)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanPostProcessorsRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span>, <span class="title">BeanFactoryAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> ConfigurableListableBeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 配置beanFactory</span></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> ConfigurableListableBeanFactory) &#123;</span><br><span class="line">            <span class="keyword">this</span>.beanFactory = (ConfigurableListableBeanFactory) beanFactory;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata,</span></span></span><br><span class="line"><span class="params"><span class="function">            BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (<span class="keyword">this</span>.beanFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         registerSyntheticBeanIfMissing(registry, <span class="string">&quot;webServerFactoryCustomizerBeanPostProcessor&quot;</span>,</span><br><span class="line">               WebServerFactoryCustomizerBeanPostProcessor.class);</span><br><span class="line">         registerSyntheticBeanIfMissing(registry, <span class="string">&quot;errorPageRegistrarBeanPostProcessor&quot;</span>,</span><br><span class="line">               ErrorPageRegistrarBeanPostProcessor.class);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerSyntheticBeanIfMissing</span><span class="params">(BeanDefinitionRegistry registry, String name, Class&lt;?&gt; beanClass)</span> </span>&#123;</span><br><span class="line">         <span class="comment">// 如果Spring容器中不存在WebServerFactoryCustomizerBeanPostProcessor和ErrorPageRegistrarBeanPostProcessor类型的bean</span></span><br><span class="line">         <span class="keyword">if</span> (ObjectUtils.isEmpty(<span class="keyword">this</span>.beanFactory.getBeanNamesForType(beanClass, <span class="keyword">true</span>, <span class="keyword">false</span>))) &#123;</span><br><span class="line">            RootBeanDefinition beanDefinition = <span class="keyword">new</span> RootBeanDefinition(beanClass);</span><br><span class="line">            beanDefinition.setSynthetic(<span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">// 则重新注册一个</span></span><br><span class="line">            registry.registerBeanDefinition(name, beanDefinition);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到上面的自动配置类中导入了三个 <code>ServletWebServerFactoryConfiguration</code> <code>的内部类，ServletWebServerFactory</code> 的注册就是在这儿完成的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServletWebServerFactoryConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Configuration</span></span><br><span class="line">   <span class="comment">// Tomcat、Servlet和UpgradeProtocol类必须在classLoader中存在</span></span><br><span class="line">   <span class="comment">// 这三个类都在tomcat包下</span></span><br><span class="line">   <span class="comment">// springboot默认使用tomcat作为servlet容器，在引入的spring-boot-starter-web这个依赖中就包含了tomcat依赖</span></span><br><span class="line">   <span class="meta">@ConditionalOnClass(&#123; Servlet.class, Tomcat.class, UpgradeProtocol.class &#125;)</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean(value = ServletWebServerFactory.class, search = SearchStrategy.CURRENT)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EmbeddedTomcat</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 将创建Tomcat容器的工厂注册到Spring容器中</span></span><br><span class="line">      <span class="meta">@Bean</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> TomcatServletWebServerFactory <span class="title">tomcatServletWebServerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> TomcatServletWebServerFactory();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Nested configuration if Jetty is being used.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Configuration</span></span><br><span class="line">   <span class="meta">@ConditionalOnClass(&#123; Servlet.class, Server.class, Loader.class, WebAppContext.class &#125;)</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean(value = ServletWebServerFactory.class, search = SearchStrategy.CURRENT)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EmbeddedJetty</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 将创建Jetty容器的工厂注册到Spring容器中</span></span><br><span class="line">      <span class="meta">@Bean</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> JettyServletWebServerFactory <span class="title">JettyServletWebServerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> JettyServletWebServerFactory();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Nested configuration if Undertow is being used.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Configuration</span></span><br><span class="line">   <span class="meta">@ConditionalOnClass(&#123; Servlet.class, Undertow.class, SslClientAuthMode.class &#125;)</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean(value = ServletWebServerFactory.class, search = SearchStrategy.CURRENT)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EmbeddedUndertow</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 将创建Undertow容器的工厂注册到Spring容器中</span></span><br><span class="line">      <span class="meta">@Bean</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> UndertowServletWebServerFactory <span class="title">undertowServletWebServerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> UndertowServletWebServerFactory();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WebServerFactoryCustomizerBeanPostProcessor"><a href="#WebServerFactoryCustomizerBeanPostProcessor" class="headerlink" title="WebServerFactoryCustomizerBeanPostProcessor"></a><code>WebServerFactoryCustomizerBeanPostProcessor</code></h3><p><code>WebServerFactoryCustomizerBeanPostProcessor</code> 是一个 <code>BeanPostProcessor</code> ，它在 <code>postProcessBeforeInitialization</code> 过程中去寻找 Spring 容器中 <code>WebServerFactoryCustomizer</code> 类型的Bean，并依次调用这个接口的 <code>customize()</code> 方法对内置容器工厂做一些定制化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    <span class="comment">// 在Spring容器中寻找WebServerFactor类型的Bean，SpringBoot内部的三种内置Servlet容器工厂都实现了这个接口，该接口的作用就是完成servlet容器的配置，注意这个类和ServletWebServerFactory不同</span></span><br><span class="line">    <span class="comment">// 比如添加Servlet初始化器addInitializers、添加错误页addErrorPages、设置session超时时间setSessionTimeout、设置端口setPort等等</span></span><br><span class="line">   <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> WebServerFactory) &#123;</span><br><span class="line">      postProcessBeforeInitialization((WebServerFactory) bean);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postProcessBeforeInitialization</span><span class="params">(WebServerFactory webServerFactory)</span> </span>&#123;</span><br><span class="line">   LambdaSafe.callbacks(WebServerFactoryCustomizer.class, getCustomizers(), webServerFactory)</span><br><span class="line">         .withLogger(WebServerFactoryCustomizerBeanPostProcessor.class)</span><br><span class="line">         <span class="comment">// 遍历获取的每个定制化器，并调用customize方法</span></span><br><span class="line">         .invoke((customizer) -&gt; customizer.customize(webServerFactory));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Collection&lt;WebServerFactoryCustomizer&lt;?&gt;&gt; getCustomizers() &#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.customizers == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Look up does not include the parent context</span></span><br><span class="line">      <span class="comment">// 找出所有的定制化器</span></span><br><span class="line">      <span class="keyword">this</span>.customizers = <span class="keyword">new</span> ArrayList&lt;&gt;(getWebServerFactoryCustomizerBeans());</span><br><span class="line">      <span class="comment">// 定制化器排序</span></span><br><span class="line">      <span class="keyword">this</span>.customizers.sort(AnnotationAwareOrderComparator.INSTANCE);</span><br><span class="line">      <span class="keyword">this</span>.customizers = Collections.unmodifiableList(<span class="keyword">this</span>.customizers);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.customizers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Collection&lt;WebServerFactoryCustomizer&lt;?&gt;&gt; getWebServerFactoryCustomizerBeans() &#123;</span><br><span class="line">   <span class="comment">// 找出Spring容器中WebServerFactoryCustomizer类型的Bean</span></span><br><span class="line">   <span class="keyword">return</span> (Collection) <span class="keyword">this</span>.beanFactory.getBeansOfType(WebServerFactoryCustomizer.class, <span class="keyword">false</span>, <span class="keyword">false</span>).values();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>WebServerFactoryCustomizer</code> 这个类主要作用就是对内置的容器工厂进行一些定制化处理，比如设置端口，地址，错误页面等</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WebServerFactoryCustomizer</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">WebServerFactory</span>&gt; </span>&#123;</span><br><span class="line">   <span class="comment">// 对内置容器工厂进行定制化处理</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">customize</span><span class="params">(T factory)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OK，到这为止，主要的涉及到加载 <strong>内置Servlet容器</strong> 的类都介绍完了，下面就以 <code>tomcat</code> 为例来看看内置 <code>Servlet</code> 的创建和启动流程。</p>
<hr>
<h2 id="二、Servlet的创建"><a href="#二、Servlet的创建" class="headerlink" title="二、Servlet的创建"></a>二、Servlet的创建</h2><p>回到之前看的 <code>SpringBoot</code> 启动代码上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 计时工具</span></span><br><span class="line">   StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">   stopWatch.start(); <span class="comment">// 开始计时，记录开始时间</span></span><br><span class="line">   </span><br><span class="line">   ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">   Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">   </span><br><span class="line">   configureHeadlessProperty();</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 1.获取并启动监听器</span></span><br><span class="line">   SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">   listeners.starting();</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(args); <span class="comment">// 构造一个应用程序参数持有类</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 2.根据SpringApplicationRunListeners和参数来准备环境</span></span><br><span class="line">      ConfigurableEnvironment environment = prepareEnvironment(listeners, applicationArguments);</span><br><span class="line">      configureIgnoreBeanInfo(environment);</span><br><span class="line"></span><br><span class="line">      Banner printedBanner = printBanner(environment); </span><br><span class="line"></span><br><span class="line">      <span class="comment">// 3.创建Spring容器</span></span><br><span class="line">      context = createApplicationContext();</span><br><span class="line">      </span><br><span class="line">      exceptionReporters = getSpringFactoriesInstances(SpringBootExceptionReporter.class,</span><br><span class="line">            <span class="keyword">new</span> Class[] &#123; ConfigurableApplicationContext.class &#125;, context);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 4.准备Spring容器</span></span><br><span class="line">      prepareContext(context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 5.刷新容器。</span></span><br><span class="line">      refreshContext(context);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 6.Spring容器后置处理</span></span><br><span class="line">      afterRefresh(context, applicationArguments);</span><br><span class="line">      </span><br><span class="line">      stopWatch.stop(); <span class="comment">// 记录结束时间</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">         <span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass).logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 7.触发结束执行的监听事件</span></span><br><span class="line">      listeners.started(context);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 8.执行Runners</span></span><br><span class="line">      callRunners(context, applicationArguments);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      handleRunFailure(context, ex, exceptionReporters, listeners);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 容器启动完成最后一刻调用这个方法</span></span><br><span class="line">      listeners.running(context);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      handleRunFailure(context, ex, exceptionReporters, <span class="keyword">null</span>);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">return</span> context; <span class="comment">// 返回容器</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="容器的创建"><a href="#容器的创建" class="headerlink" title="容器的创建"></a>容器的创建</h3><p>重点看一下第三步—<strong>创建Spring容器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ConfigurableApplicationContext <span class="title">createApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   Class&lt;?&gt; contextClass = <span class="keyword">this</span>.applicationContextClass;</span><br><span class="line">   <span class="keyword">if</span> (contextClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">switch</span> (<span class="keyword">this</span>.webApplicationType) &#123;</span><br><span class="line">         <span class="keyword">case</span> SERVLET:</span><br><span class="line">            contextClass = Class.forName(DEFAULT_SERVLET_WEB_CONTEXT_CLASS);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> REACTIVE:</span><br><span class="line">            contextClass = Class.forName(DEFAULT_REACTIVE_WEB_CONTEXT_CLASS);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">default</span>:</span><br><span class="line">            contextClass = Class.forName(DEFAULT_CONTEXT_CLASS);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">               <span class="string">&quot;Unable create a default ApplicationContext, &quot;</span> + <span class="string">&quot;please specify an ApplicationContextClass&quot;</span>,</span><br><span class="line">               ex);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> (ConfigurableApplicationContext) BeanUtils.instantiateClass(contextClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据 <code>webApplicationType</code> 判断当前服务的类型，然后创建对应的 <code>Spring</code> 容器，以 <code>web</code> 程序为例，这里就会执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contextClass = Class.forName(DEFAULT_SERVLET_WEB_CONTEXT_CLASS);</span><br></pre></td></tr></table></figure>
<p>对应的类是<code>AnnotationConfigServletWebServerApplicationContext</code>，因此最终创建的容器就是<code>AnnotationConfigServletWebServerApplicationContext</code><br><img src="https://ae01.alicdn.com/kf/U057c7dcbcaf84639b7485ed4edbc442cY.jpg"></p>
<h3 id="容器的配置"><a href="#容器的配置" class="headerlink" title="容器的配置"></a>容器的配置</h3><p>再来看一下第五步—<strong>刷新容器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshContext</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span><br><span class="line">   refresh(context);</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.registerShutdownHook) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         context.registerShutdownHook();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (AccessControlException ex) &#123;</span><br><span class="line">         <span class="comment">// Not allowed in some environments.</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">(ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">   Assert.isInstanceOf(AbstractApplicationContext.class, applicationContext);    </span><br><span class="line">   <span class="comment">// 调用容器的 refresh() 方法进行刷新</span></span><br><span class="line">   ((AbstractApplicationContext) applicationContext).refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进到 <code>refresh()</code> 方法中看一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">   <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">      <span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">      prepareRefresh();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line">      ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Prepare the bean factory for use in this context.</span></span><br><span class="line">      prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">         postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">         invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Register bean processors that intercept bean creation.</span></span><br><span class="line">         registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Initialize message source for this context.</span></span><br><span class="line">         initMessageSource();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Initialize event multicaster for this context.</span></span><br><span class="line">         initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">         onRefresh();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Check for listener beans and register them.</span></span><br><span class="line">         registerListeners();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">         finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">         finishRefresh();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">         <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Destroy already created singletons to avoid dangling resources.</span></span><br><span class="line">         destroyBeans();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Reset &#x27;active&#x27; flag.</span></span><br><span class="line">         cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Propagate exception to caller.</span></span><br><span class="line">         <span class="keyword">throw</span> ex;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="comment">// Reset common introspection caches in Spring&#x27;s core, since we</span></span><br><span class="line">         <span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">         resetCommonCaches();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看一下 <code>onRefresh()</code> 这个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">   <span class="comment">// For subclasses: do nothing by default.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>是个空方法，但是使用了 <code>protected</code> 进行修饰，也就是子类可以重写这个方法，那我们去子类看一下具体的实现，进到 <code>ServletWebServerApplicationContext</code> 这个类中，这个类是我们之前创建的Spring容器 <code>AnnotationConfigServletWebServerApplicationContext</code> 的父类。这个类实现了<code>onRefresh()</code>方法，在其中完成了对内置Servlet容器的获取。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">super</span>.onRefresh();</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 核心方法，获取内置容器工厂，并通过工厂获取Servlet容器</span></span><br><span class="line">      createWebServer();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">&quot;Unable to start web server&quot;</span>, ex);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createWebServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   WebServer webServer = <span class="keyword">this</span>.webServer;</span><br><span class="line">   ServletContext servletContext = getServletContext();</span><br><span class="line">   <span class="comment">// 内置Servlet容器和ServletContext都没初始化的时候执行</span></span><br><span class="line">   <span class="keyword">if</span> (webServer == <span class="keyword">null</span> &amp;&amp; servletContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 从Spring容器中获取内置容器工厂，如果包含多个ServletWebServerFactory或者不存在则会抛出异常终止程序</span></span><br><span class="line">      ServletWebServerFactory factory = getWebServerFactory();</span><br><span class="line">      <span class="comment">// 通过工厂获取Servlet容器，并调用Servlet初始化器中的 onStartUp() 方法</span></span><br><span class="line">      <span class="keyword">this</span>.webServer = factory.getWebServer(getSelfInitializer());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 内置容器已经初始化但是servletContext还没初始化的时候执行</span></span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (servletContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;    </span><br><span class="line">         <span class="comment">// 调用已经存在的Servlet初始化器中的onStartUp()方法</span></span><br><span class="line">         getSelfInitializer().onStartup(servletContext);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (ServletException ex) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">&quot;Cannot initialize servlet context&quot;</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   initPropertySources();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>getWebServerFactory()</code>,获取内置容器工厂,上面我们讲过三种内置 <code>Servlet</code> 工厂的注册过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ServletWebServerFactory <span class="title">getWebServerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Use bean names so that we don&#x27;t consider the hierarchy\</span></span><br><span class="line">   <span class="comment">// 从Spring容器中获取ServletWebServerFactory.class类型的Bean</span></span><br><span class="line">   String[] beanNames = getBeanFactory().getBeanNamesForType(ServletWebServerFactory.class);</span><br><span class="line">   <span class="keyword">if</span> (beanNames.length == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">&quot;Unable to start ServletWebServerApplicationContext due to missing &quot;</span></span><br><span class="line">            + <span class="string">&quot;ServletWebServerFactory bean.&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (beanNames.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">&quot;Unable to start ServletWebServerApplicationContext due to multiple &quot;</span></span><br><span class="line">            + <span class="string">&quot;ServletWebServerFactory beans : &quot;</span> + StringUtils.arrayToCommaDelimitedString(beanNames));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 实例化ServletWebServerFactory.class</span></span><br><span class="line">   <span class="keyword">return</span> getBeanFactory().getBean(beanNames[<span class="number">0</span>], ServletWebServerFactory.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再来看一下 <code>getSelfInitializer()</code> 这个方法，这是一个函数式接口，它主要就是获取 <strong>Servlet初始化器</strong>，这个初始化器内部会构造一个<code>ServletContextInitializerBeans</code>(<strong>Servlet初始化器—ServletContextInitializer的集合</strong>)，<code>ServletContextInitializerBeans</code>构造时会去 Spring 容器中寻找 <code>ServletContextInitializer</code> 类型的bean，其中 <code>ServletRegistrationBean</code>、<code>FilterRegistrationBean</code>、<code>ServletListenerRegistrationBean</code>会被找出(如果有定义)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> org.springframework.boot.web.servlet.<span class="function">ServletContextInitializer <span class="title">getSelfInitializer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>::selfInitialize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">selfInitialize</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">   prepareWebApplicationContext(servletContext);</span><br><span class="line">   registerApplicationScope(servletContext);</span><br><span class="line">   WebApplicationContextUtils.registerEnvironmentBeans(getBeanFactory(), servletContext);</span><br><span class="line">   <span class="comment">// 获取所有的 ServletContextInitializer 实现类</span></span><br><span class="line">   <span class="keyword">for</span> (ServletContextInitializer beans : getServletContextInitializerBeans()) &#123;</span><br><span class="line">      <span class="comment">// 执行所有获取到的 ServletContextInitializer 的 onStartUp() 方法</span></span><br><span class="line">      beans.onStartup(servletContext);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>getServletContextInitializerBeans()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Collection&lt;ServletContextInitializer&gt; <span class="title">getServletContextInitializerBeans</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 构造一个ServletContextInitializerBeans，这个类是 ServletContextInitializer 实现类的集合</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ServletContextInitializerBeans(getBeanFactory());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ServletContextInitializerBeans</code>对象是对<code>ServletContextInitializer</code>的一种包装</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletContextInitializerBeans</span> <span class="keyword">extends</span> <span class="title">AbstractCollection</span>&lt;<span class="title">ServletContextInitializer</span>&gt; </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> MultiValueMap&lt;Class&lt;?&gt;, ServletContextInitializer&gt; initializers;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Class&lt;? extends ServletContextInitializer&gt;&gt; initializerTypes;</span><br><span class="line">  </span><br><span class="line">   <span class="keyword">private</span> List&lt;ServletContextInitializer&gt; sortedList;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ServletContextInitializerBeans</span><span class="params">(ListableBeanFactory beanFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">         Class&lt;? extends ServletContextInitializer&gt;... initializerTypes)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.initializers = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">      <span class="comment">// 存放 ServletContextInitializer.class，后续会获取这个类型的Bean</span></span><br><span class="line">      <span class="keyword">this</span>.initializerTypes = (initializerTypes.length != <span class="number">0</span>) ? Arrays.asList(initializerTypes)</span><br><span class="line">            : Collections.singletonList(ServletContextInitializer.class);</span><br><span class="line">      <span class="comment">// 获取 ServletContextInitializer 类型的bean，并添加到集合中</span></span><br><span class="line">      addServletContextInitializerBeans(beanFactory);</span><br><span class="line">      addAdaptableBeans(beanFactory);</span><br><span class="line">      List&lt;ServletContextInitializer&gt; sortedInitializers = <span class="keyword">this</span>.initializers.values().stream()</span><br><span class="line">            .flatMap((value) -&gt; value.stream().sorted(AnnotationAwareOrderComparator.INSTANCE))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">      <span class="keyword">this</span>.sortedList = Collections.unmodifiableList(sortedInitializers);</span><br><span class="line">      logMappings(<span class="keyword">this</span>.initializers);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>addServletContextInitializerBeans()</code>方法，在这里获取所有<code>ServletContextInitializer</code>类型的 <code>bean</code> ，并存放到<code>initializers</code>中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addServletContextInitializerBeans</span><span class="params">(ListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">for</span> (Class&lt;? extends ServletContextInitializer&gt; initializerType : <span class="keyword">this</span>.initializerTypes) &#123;</span><br><span class="line">      <span class="comment">//获取所有ServletContextInitializer类型的bean</span></span><br><span class="line">      <span class="keyword">for</span> (Entry&lt;String, ? extends ServletContextInitializer&gt; initializerBean : getOrderedBeansOfType(beanFactory,</span><br><span class="line">            initializerType)) &#123;</span><br><span class="line">         <span class="comment">// 存放到集合中</span></span><br><span class="line">         addServletContextInitializerBean(initializerBean.getKey(), initializerBean.getValue(), beanFactory);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在这里获取到我们自定义的ServletRegistrationBean、FilterRegistrationBean、ServletListenerRegistrationBean，并加入到initializers集合中</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addServletContextInitializerBean</span><span class="params">(String beanName, ServletContextInitializer initializer, ListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 判断是不是ServletRegistrationBean类型</span></span><br><span class="line">   <span class="keyword">if</span> (initializer <span class="keyword">instanceof</span> ServletRegistrationBean) &#123;</span><br><span class="line">      Servlet source = ((ServletRegistrationBean&lt;?&gt;) initializer).getServlet();</span><br><span class="line">      addServletContextInitializerBean(Servlet.class, beanName, initializer, beanFactory, source);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 判断是不是FilterRegistrationBean类型</span></span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (initializer <span class="keyword">instanceof</span> FilterRegistrationBean) &#123;</span><br><span class="line">      Filter source = ((FilterRegistrationBean&lt;?&gt;) initializer).getFilter();</span><br><span class="line">      addServletContextInitializerBean(Filter.class, beanName, initializer, beanFactory, source);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (initializer <span class="keyword">instanceof</span> DelegatingFilterProxyRegistrationBean) &#123;</span><br><span class="line">      String source = ((DelegatingFilterProxyRegistrationBean) initializer).getTargetBeanName();</span><br><span class="line">      addServletContextInitializerBean(Filter.class, beanName, initializer, beanFactory, source);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (initializer <span class="keyword">instanceof</span> ServletListenerRegistrationBean) &#123;</span><br><span class="line">      EventListener source = ((ServletListenerRegistrationBean&lt;?&gt;) initializer).getListener();</span><br><span class="line">      addServletContextInitializerBean(EventListener.class, beanName, initializer, beanFactory, source);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      addServletContextInitializerBean(ServletContextInitializer.class, beanName, initializer, beanFactory,</span><br><span class="line">            initializer);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addServletContextInitializerBean</span><span class="params">(Class&lt;?&gt; type, String beanName, ServletContextInitializer initializer,</span></span></span><br><span class="line"><span class="params"><span class="function">      ListableBeanFactory beanFactory, Object source)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 存放到initializers集合中</span></span><br><span class="line">   <span class="keyword">this</span>.initializers.add(type, initializer);</span><br><span class="line">   <span class="keyword">if</span> (source != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Mark the underlying source as seen in case it wraps an existing bean</span></span><br><span class="line">      <span class="comment">// 将添加过的Bean做一个标记，防止重复添加</span></span><br><span class="line">      <span class="keyword">this</span>.seen.add(source);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">      String resourceDescription = getResourceDescription(beanName, beanFactory);</span><br><span class="line">      <span class="keyword">int</span> order = getOrder(initializer);</span><br><span class="line">      logger.trace(<span class="string">&quot;Added existing &quot;</span> + type.getSimpleName() + <span class="string">&quot; initializer bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;; order=&quot;</span></span><br><span class="line">            + order + <span class="string">&quot;, resource=&quot;</span> + resourceDescription);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这些 <code>ServletContextInitializer</code> 类型的 <code>bean</code> 例如 <code>ServletRegistrationBean.class</code>，通过 <code>SpringBoot</code> 的 <code>AutoConfiguration</code> 装配到 <code>Spring</code> 容器 中，在注册时会将对应的 <code>Servlet</code> 添加到自己的参数中，我们以 <code>DispatchServletRegistrationBean</code> 为例来看一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="comment">// classpath中必须存在DispatcherServlet.class的字节码</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(DispatcherServlet.class)</span></span><br><span class="line"><span class="comment">// 这个配置类的执行要在EmbeddedServletContainerAutoConfiguration配置类生效之后执行</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(ServletWebServerFactoryAutoConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherServletAutoConfiguration</span> </span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_DISPATCHER_SERVLET_BEAN_NAME = <span class="string">&quot;dispatcherServlet&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME = <span class="string">&quot;dispatcherServletRegistration&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Configuration</span></span><br><span class="line">   <span class="meta">@Conditional(DefaultDispatcherServletCondition.class)</span></span><br><span class="line">   <span class="meta">@ConditionalOnClass(ServletRegistration.class)</span></span><br><span class="line">   <span class="meta">@EnableConfigurationProperties(&#123; HttpProperties.class, WebMvcProperties.class &#125;)</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherServletConfiguration</span> </span>&#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> HttpProperties httpProperties;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> WebMvcProperties webMvcProperties;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">DispatcherServletConfiguration</span><span class="params">(HttpProperties httpProperties, WebMvcProperties webMvcProperties)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.httpProperties = httpProperties;</span><br><span class="line">         <span class="keyword">this</span>.webMvcProperties = webMvcProperties;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 注册dispatcherServlet</span></span><br><span class="line">      <span class="meta">@Bean(name = DEFAULT_DISPATCHER_SERVLET_BEAN_NAME)</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> DispatcherServlet <span class="title">dispatcherServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="comment">// 构造一个DispatcherServlet，并添加一些webMvcProperties配置</span></span><br><span class="line">         DispatcherServlet dispatcherServlet = <span class="keyword">new</span> DispatcherServlet();</span><br><span class="line">         dispatcherServlet.setDispatchOptionsRequest(<span class="keyword">this</span>.webMvcProperties.isDispatchOptionsRequest());</span><br><span class="line">         dispatcherServlet.setDispatchTraceRequest(<span class="keyword">this</span>.webMvcProperties.isDispatchTraceRequest());</span><br><span class="line">         dispatcherServlet</span><br><span class="line">               .setThrowExceptionIfNoHandlerFound(<span class="keyword">this</span>.webMvcProperties.isThrowExceptionIfNoHandlerFound());</span><br><span class="line">         dispatcherServlet.setEnableLoggingRequestDetails(<span class="keyword">this</span>.httpProperties.isLogRequestDetails());</span><br><span class="line">         <span class="keyword">return</span> dispatcherServlet;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 注册文件上传相关的Bean</span></span><br><span class="line">      <span class="meta">@Bean</span></span><br><span class="line">      <span class="meta">@ConditionalOnBean(MultipartResolver.class)</span></span><br><span class="line">      <span class="meta">@ConditionalOnMissingBean(name = DispatcherServlet.MULTIPART_RESOLVER_BEAN_NAME)</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> MultipartResolver <span class="title">multipartResolver</span><span class="params">(MultipartResolver resolver)</span> </span>&#123;</span><br><span class="line">         <span class="comment">// Detect if the user has created a MultipartResolver but named it incorrectly</span></span><br><span class="line">         <span class="keyword">return</span> resolver;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="meta">@Configuration</span></span><br><span class="line">   <span class="meta">@Conditional(DispatcherServletRegistrationCondition.class)</span></span><br><span class="line">   <span class="comment">// classPath中必须存在ServletRegistration.class，毕竟DispatcherServletRegistrationBean.class是它的实现类</span></span><br><span class="line">   <span class="meta">@ConditionalOnClass(ServletRegistration.class)</span></span><br><span class="line">   <span class="meta">@EnableConfigurationProperties(WebMvcProperties.class)</span></span><br><span class="line">   <span class="meta">@Import(DispatcherServletConfiguration.class)</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherServletRegistrationConfiguration</span> </span>&#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> WebMvcProperties webMvcProperties;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> MultipartConfigElement multipartConfig;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">DispatcherServletRegistrationConfiguration</span><span class="params">(WebMvcProperties webMvcProperties,</span></span></span><br><span class="line"><span class="params"><span class="function">            ObjectProvider&lt;MultipartConfigElement&gt; multipartConfigProvider)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.webMvcProperties = webMvcProperties;</span><br><span class="line">         <span class="keyword">this</span>.multipartConfig = multipartConfigProvider.getIfAvailable();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 注册DispatcherServletRegistrationBean</span></span><br><span class="line">      <span class="meta">@Bean(name = DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME)</span></span><br><span class="line">      <span class="meta">@ConditionalOnBean(value = DispatcherServlet.class, name = DEFAULT_DISPATCHER_SERVLET_BEAN_NAME)</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> DispatcherServletRegistrationBean <span class="title">dispatcherServletRegistration</span><span class="params">(DispatcherServlet dispatcherServlet)</span> </span>&#123;</span><br><span class="line">         <span class="comment">// 构造一个DispatcherServletRegistrationBean，并将dispatcherServlet作为参数传入</span></span><br><span class="line">         DispatcherServletRegistrationBean registration = <span class="keyword">new</span> DispatcherServletRegistrationBean(dispatcherServlet,</span><br><span class="line">               <span class="keyword">this</span>.webMvcProperties.getServlet().getPath());</span><br><span class="line">         registration.setName(DEFAULT_DISPATCHER_SERVLET_BEAN_NAME);</span><br><span class="line">         registration.setLoadOnStartup(<span class="keyword">this</span>.webMvcProperties.getServlet().getLoadOnStartup());</span><br><span class="line">         <span class="keyword">if</span> (<span class="keyword">this</span>.multipartConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">            registration.setMultipartConfig(<span class="keyword">this</span>.multipartConfig);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> registration;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这些<code>ServletContextInitializer</code>类型的<code>Bean</code>注册到Spring容器之后，在<code>addServletContextInitializerBeans()</code>方法中就会被获取到并存放到<code>initializers</code>集合中。</p>
<p>再来看看另一个方法<code>addAdaptableBeans(beanFactory)</code>，与上面的方法不同，这个是直接获取<code>Servlet.class</code>和<code>Filter.class</code>类型的<code>Bean</code>，并通过对应的<code>adapter</code>将其构建为<code>RegistrationBean</code>对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addAdaptableBeans</span><span class="params">(ListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">   MultipartConfigElement multipartConfig = getMultipartConfig(beanFactory);</span><br><span class="line">   <span class="comment">// 从Spring容器中获取所有的Servlet.class和Filter.class类型的bean，并封装成RegistrationBean对象，加入到集合汇总</span></span><br><span class="line">   addAsRegistrationBean(beanFactory, Servlet.class, <span class="keyword">new</span> ServletRegistrationBeanAdapter(multipartConfig));</span><br><span class="line">   addAsRegistrationBean(beanFactory, Filter.class, <span class="keyword">new</span> FilterRegistrationBeanAdapter());</span><br><span class="line">   <span class="keyword">for</span> (Class&lt;?&gt; listenerType : ServletListenerRegistrationBean.getSupportedTypes()) &#123;</span><br><span class="line">      addAsRegistrationBean(beanFactory, EventListener.class, (Class&lt;EventListener&gt;) listenerType,</span><br><span class="line">            <span class="keyword">new</span> ServletListenerRegistrationBeanAdapter());</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">addAsRegistrationBean</span><span class="params">(ListableBeanFactory beanFactory, Class&lt;T&gt; type,</span></span></span><br><span class="line"><span class="params"><span class="function">      RegistrationBeanAdapter&lt;T&gt; adapter)</span> </span>&#123;</span><br><span class="line">   addAsRegistrationBean(beanFactory, type, type, adapter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;T, B extends T&gt; <span class="function"><span class="keyword">void</span> <span class="title">addAsRegistrationBean</span><span class="params">(ListableBeanFactory beanFactory, Class&lt;T&gt; type,</span></span></span><br><span class="line"><span class="params"><span class="function">      Class&lt;B&gt; beanType, RegistrationBeanAdapter&lt;T&gt; adapter)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 从Spring容器中获取Servlet.class和Filter.class类型的Bean，并且尚未被加入到this.seen集合中的</span></span><br><span class="line">   List&lt;Map.Entry&lt;String, B&gt;&gt; entries = getOrderedBeansOfType(beanFactory, beanType, <span class="keyword">this</span>.seen);</span><br><span class="line">   <span class="keyword">for</span> (Entry&lt;String, B&gt; entry : entries) &#123;</span><br><span class="line">      String beanName = entry.getKey();</span><br><span class="line">      B bean = entry.getValue();</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.seen.add(bean)) &#123;</span><br><span class="line">         <span class="comment">// One that we haven&#x27;t already seen</span></span><br><span class="line">         <span class="comment">// 通过ServletRegistrationBeanAdapter和FilterRegistrationBeanAdapter两个适配器将Servlet.class和Filter.class类型的bean包装成RegistrationBean对象</span></span><br><span class="line">         RegistrationBean registration = adapter.createRegistrationBean(beanName, bean, entries.size());</span><br><span class="line">         <span class="keyword">int</span> order = getOrder(bean);</span><br><span class="line">         registration.setOrder(order);</span><br><span class="line">         <span class="comment">// 添加到initializers集合中</span></span><br><span class="line">         <span class="keyword">this</span>.initializers.add(type, registration);</span><br><span class="line">         <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">&quot;Created &quot;</span> + type.getSimpleName() + <span class="string">&quot; initializer for bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;; order=&quot;</span></span><br><span class="line">                  + order + <span class="string">&quot;, resource=&quot;</span> + getResourceDescription(beanName, beanFactory));</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 <code>ServletRegistrationBeanAdapter</code> 和 <code>FilterRegistrationBeanAdapter</code> 将 <code>Servlet.class</code> 和 <code>Fliter.class</code> 封装成<code>ServletRegistrationBean</code>对象和<code>FilterRegistrationBean</code>对象，这<strong>与前通过<code>AutoConfiguration</code>自动装配的<code>RegistrationBean</code>是一样的</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletRegistrationBeanAdapter</span> <span class="keyword">implements</span> <span class="title">RegistrationBeanAdapter</span>&lt;<span class="title">Servlet</span>&gt; </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> MultipartConfigElement multipartConfig;</span><br><span class="line"></span><br><span class="line">   ServletRegistrationBeanAdapter(MultipartConfigElement multipartConfig) &#123;</span><br><span class="line">      <span class="keyword">this</span>.multipartConfig = multipartConfig;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> RegistrationBean <span class="title">createRegistrationBean</span><span class="params">(String name, Servlet source, <span class="keyword">int</span> totalNumberOfSourceBeans)</span> </span>&#123;</span><br><span class="line">      String url = (totalNumberOfSourceBeans != <span class="number">1</span>) ? <span class="string">&quot;/&quot;</span> + name + <span class="string">&quot;/&quot;</span> : <span class="string">&quot;/&quot;</span>;</span><br><span class="line">      <span class="keyword">if</span> (name.equals(DISPATCHER_SERVLET_NAME)) &#123;</span><br><span class="line">         url = <span class="string">&quot;/&quot;</span>; <span class="comment">// always map the main dispatcherServlet to &quot;/&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 将Servlet.class实例封装成ServletRegistrationBean对象</span></span><br><span class="line">      ServletRegistrationBean&lt;Servlet&gt; bean = <span class="keyword">new</span> ServletRegistrationBean&lt;&gt;(source, url);</span><br><span class="line">      bean.setName(name);</span><br><span class="line">      bean.setMultipartConfig(<span class="keyword">this</span>.multipartConfig);</span><br><span class="line">      <span class="keyword">return</span> bean;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FilterRegistrationBeanAdapter</span> <span class="keyword">implements</span> <span class="title">RegistrationBeanAdapter</span>&lt;<span class="title">Filter</span>&gt; </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> RegistrationBean <span class="title">createRegistrationBean</span><span class="params">(String name, Filter source, <span class="keyword">int</span> totalNumberOfSourceBeans)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 将Filter.class实例封装成FilterRegistrationBean对象</span></span><br><span class="line">      FilterRegistrationBean&lt;Filter&gt; bean = <span class="keyword">new</span> FilterRegistrationBean&lt;&gt;(source);</span><br><span class="line">      bean.setName(name);</span><br><span class="line">      <span class="keyword">return</span> bean;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面这些 <code>Bean</code> 就是通过上面两个方法获取到的 <code>ServletContextInitializer</code> 类型的实例<br><img src="https://ae01.alicdn.com/kf/U0799dee9f7204848bf55cfa5309a45c5Q.jpg" alt="ServletContextInitializer类型的实例"></p>
<p>获取到了所有 <code>ServletContextInitializer</code> 类型的 <code>Bean</code> 之后，就该调用它们的 <code>onStartUp()</code> 方法了，下面就以 <code>ServletRegistrationBean</code> 为例来看一下这个方法，先来看一下类关系图<br><img src="https://ae01.alicdn.com/kf/U75e56c15f3124f32a624fd9928842817M.jpg" alt="ServletRegistrationBean的类关系图"></p>
<p>当调用 <code>ServletContextInitializer</code> 的 <code>onStartUp()</code> 方法时，首先进入到<code>RegistrationBean</code>类中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistrationBean</span> <span class="keyword">implements</span> <span class="title">ServletContextInitializer</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">      String description = getDescription();</span><br><span class="line">      <span class="keyword">if</span> (!isEnabled()) &#123;</span><br><span class="line">         logger.info(StringUtils.capitalize(description) + <span class="string">&quot; was not registered (disabled)&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 调用子类代码配置servletContext</span></span><br><span class="line">      register(description, servletContext);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(String description, ServletContext servletContext)</span></span>;</span><br></pre></td></tr></table></figure>
<p>接着看<code>RegistrationBean</code>的子类<code>DynamicRegistrationBean</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicRegistrationBean</span>&lt;<span class="title">D</span> <span class="keyword">extends</span> <span class="title">Registration</span>.<span class="title">Dynamic</span>&gt; <span class="keyword">extends</span> <span class="title">RegistrationBean</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(String description, ServletContext servletContext)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 关键代码，调用子类ServletRegistrationBean的方法获取Servlet的name，然后调用SerlvetContext的addServlet方法将Servlet加入到Tomcat中</span></span><br><span class="line">      D registration = addRegistration(description, servletContext);</span><br><span class="line">      <span class="keyword">if</span> (registration == <span class="keyword">null</span>) &#123;</span><br><span class="line">         logger.info(</span><br><span class="line">               StringUtils.capitalize(description) + <span class="string">&quot; was not registered &quot;</span> + <span class="string">&quot;(possibly already registered?)&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 完成一些额外的配置</span></span><br><span class="line">      configure(registration);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后再看<code>DynamicRegistrationBean</code>的子类<code>ServletRegistrationBean</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   Assert.notNull(<span class="keyword">this</span>.servlet, <span class="string">&quot;Servlet must not be null&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&quot;servlet &quot;</span> + getServletName();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> ServletRegistration.<span class="function">Dynamic <span class="title">addRegistration</span><span class="params">(String description, ServletContext servletContext)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 获取Servlet的name</span></span><br><span class="line">   String name = getServletName();</span><br><span class="line">   <span class="comment">// 将Servlet加入到内置Servlet容器中</span></span><br><span class="line">   <span class="keyword">return</span> servletContext.addServlet(name, <span class="keyword">this</span>.servlet);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ServletRegistration.Dynamic registration)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">super</span>.configure(registration);</span><br><span class="line">   String[] urlMapping = StringUtils.toStringArray(<span class="keyword">this</span>.urlMappings);</span><br><span class="line">   <span class="keyword">if</span> (urlMapping.length == <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.alwaysMapUrl) &#123;</span><br><span class="line">      urlMapping = DEFAULT_MAPPINGS;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (!ObjectUtils.isEmpty(urlMapping)) &#123;</span><br><span class="line">      registration.addMapping(urlMapping);</span><br><span class="line">   &#125;</span><br><span class="line">   registration.setLoadOnStartup(<span class="keyword">this</span>.loadOnStartup);</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.multipartConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">      registration.setMultipartConfig(<span class="keyword">this</span>.multipartConfig);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进行完以上 <code>onStartUp()</code> 方法后，<code>Servlet</code>就被加入到<code>Tomcat</code>中了，这样我们就能发送请求给这个<code>Servlet</code>了。</p>
<p><code>Filter</code>的配置流程同上，将<code>Filter</code>通过<code>addFilter()</code>加入到<code>Tomcat</code>中之后，<code>Filter</code>就能进行请求拦截了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Dynamic <span class="title">addRegistration</span><span class="params">(String description, ServletContext servletContext)</span> </span>&#123;</span><br><span class="line">   Filter filter = getFilter();</span><br><span class="line">   <span class="keyword">return</span> servletContext.addFilter(getOrDeduceName(filter), filter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="三、Servlet的启动"><a href="#三、Servlet的启动" class="headerlink" title="三、Servlet的启动"></a>三、Servlet的启动</h2><p><code>Servlet</code> 容器创建完毕之后在 <code>finishRefresh()</code> 方法中会被启动，让我们回到 <code>ServletWebServerApplicationContext.class</code> 中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">super</span>.finishRefresh();</span><br><span class="line">   <span class="comment">// 启动内置Servlet容器</span></span><br><span class="line">   WebServer webServer = startWebServer();</span><br><span class="line">   <span class="keyword">if</span> (webServer != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 内置Servlet容器启动成功，发布ServletWebServerInitializedEvent事件</span></span><br><span class="line">      publishEvent(<span class="keyword">new</span> ServletWebServerInitializedEvent(webServer, <span class="keyword">this</span>));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> WebServer <span class="title">startWebServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 拿到在onRefresh方法中构造的内置Servlet容器webServer</span></span><br><span class="line">   WebServer webServer = <span class="keyword">this</span>.webServer;</span><br><span class="line">   <span class="keyword">if</span> (webServer != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 启动</span></span><br><span class="line">      webServer.start();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> webServer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到此为止，内置的 <code>Servlet</code> 容器就完成了创建和启动的流程。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/SpringBoot/" rel="tag"># SpringBoot</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020-06-13/34219/" rel="prev" title="SpringBoot源码学习(二)---Spring容器refresh流程">
      <i class="fa fa-chevron-left"></i> SpringBoot源码学习(二)---Spring容器refresh流程
    </a></div>
      <div class="post-nav-item">
    <a href="/2020-08-25/40693/" rel="next" title="Java并发---学习笔记">
      Java并发---学习笔记 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E7%9B%B8%E5%85%B3%E7%B1%BB%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">一、相关类介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#WebServer"><span class="nav-number">1.1.</span> <span class="nav-text">WebServer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ServletWebServerFactory"><span class="nav-number">1.2.</span> <span class="nav-text">ServletWebServerFactory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ServletContextInitializer"><span class="nav-number">1.3.</span> <span class="nav-text">ServletContextInitializer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ServletWebServerFactoryAutoConfiguration"><span class="nav-number">1.4.</span> <span class="nav-text">ServletWebServerFactoryAutoConfiguration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WebServerFactoryCustomizerBeanPostProcessor"><span class="nav-number">1.5.</span> <span class="nav-text">WebServerFactoryCustomizerBeanPostProcessor</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81Servlet%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="nav-number">2.</span> <span class="nav-text">二、Servlet的创建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="nav-number">2.1.</span> <span class="nav-text">容器的创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-number">2.2.</span> <span class="nav-text">容器的配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81Servlet%E7%9A%84%E5%90%AF%E5%8A%A8"><span class="nav-number">3.</span> <span class="nav-text">三、Servlet的启动</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="sxh"
      src="https://fastly.jsdelivr.net/gh/JokerByrant/Images@main/blog/16996066179231699606617191.png">
  <p class="site-author-name" itemprop="name">sxh</p>
  <div class="site-description" itemprop="description">人类的悲欢并不相通</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">119</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">67</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sxh</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>















  

  

  <!-- 页面点击礼花效果 -->
<script type="text/javascript" src="/js/firework.js"></script>
</body>
</html>
